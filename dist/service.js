'use strict';var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h['return']&&h['return']()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_light=require('protobufjs/light'),_light2=_interopRequireDefault(_light),_metrics=require('./metrics.json'),_metrics2=_interopRequireDefault(_metrics),_featureDetectionService=require('./feature-detection-service.js'),_featureDetectionService2=_interopRequireDefault(_featureDetectionService);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function invertObjectKV(a){var b={};for(var c in a)b[a[c]]=c;return b}function isDefined(a){return'undefined'!=typeof a}var metricsMessage=_light2.default.Root.fromJSON(_metrics2.default).lookupType('fsMetrics.fsMetricsMessage'),fsMetrics=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=b.$window,d=void 0===c?window:c,e=b.$timeout,f=void 0===e?window.setTimeout:e,g=b.XMLHttpRequest,h=void 0===g?window.XMLHttpRequest:g,i=b.globalTags,j=b.timingRanges,k=b.codeRevision,l=b.stringReplace,m=b.blackList,n=b.whiteList,o=b.timelinePrefix;_classCallCheck(this,a),this.$window=d,this.$timeout=f,this.XMLHttpRequest=h,this.globalTags=i||[],this.timingRanges=j,this.codeRevision=k,this.stringReplace=l,this.blackList=m,this.whiteList=n,this.timelinePrefix=o,this.loadFired=!1,this.resetQueue(),this.buildServerSharedDictionary(),this.trackUnsupportedFeatures(),this.upgradeQueue(),this.trackExistingPerformanceEntries()}return _createClass(a,[{key:'trackExistingPerformanceEntries',value:function trackExistingPerformanceEntries(){var a=this;_featureDetectionService2.default.performanceTimeline&&(this.$window.performance.getEntries().forEach(function(b){('measure'===b.entryType||'resource'===b.entryType)&&a.performanceTiming(b)}),'true'!==this.config.timeParse&&this.$window.performance.clearMeasures(),_featureDetectionService2.default.clearResourceTimings&&this.$window.performance.clearResourceTimings())}},{key:'trackUnsupportedFeatures',value:function trackUnsupportedFeatures(){_featureDetectionService2.default.navigationTiming||this.increment('timingUnsupported'),_featureDetectionService2.default.mark||this.increment('markUnsupported'),_featureDetectionService2.default.measure||this.increment('markUnsupported'),_featureDetectionService2.default.performanceTimeline||this.increment('resourceTimingUnsupported')}},{key:'buildServerSharedDictionary',value:function buildServerSharedDictionary(a,b,c){var d=this;this.metricNames={},this.metricTags={},this.eventTypes={},a&&this.config.metricNames.forEach(function(a,b){return d.metricNames[a]=b}),b&&this.config.metricTags.forEach(function(a,b){return d.metricTags[a]=''+b}),c&&this.config.eventTypes.forEach(function(a,b){return d.eventTypes[a]=b})}},{key:'upgradeQueue',value:function upgradeQueue(){this.$window.fsMetrics&&Array.isArray(this.$window.fsMetrics)&&Array.prototype.push===this.$window.fsMetrics.push&&(this.$window.fsMetrics.push=this.convertWindowQueue.bind(this),this.$window.fsMetrics.forEach(this.$window.fsMetrics.push))}},{key:'convertWindowQueue',value:function convertWindowQueue(a){var b=_slicedToArray(a,5),c=b[0],d=b[1],e=b[2],f=void 0===e?1:e,g=b[3],h=void 0===g?{}:g,i=b[4];if('pageload'!==c)'string'==typeof c&&(c=this.eventTypes[c]),this.queueMetric(c,d,f,h,void 0!==i&&i);else if(h.dest=d,_featureDetectionService2.default.navigationTiming){var j=window.performance.timing.domContentLoadedEventStart-window.performance.timing.navigationStart;1.2e5>j?this.timing('domContentLoaded',j,h,!0):this.increment('timingOutlier',h,!0)}else this.increment('timingUnsupported',h,!0)}},{key:'resetQueue',value:function resetQueue(){this.queue=[],this.activeBuffer&&this.$window.clearTimeout(this.activeBuffer),this.activeBuffer=!1}},{key:'normalizeTag',value:function normalizeTag(a){return a+='',this.stringReplace.reduce(function(a,b){var c=_slicedToArray(b,2),d=c[0],e=c[1];return a.replace(d,e)},a)}},{key:'encodeStat',value:function encodeStat(){for(var a=this,b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];return c.reduce(function(b,c){return c?(c+='',b+c.replace(/[^\w:.-]+/g,'_')):c&&isDefined(a.metricNames[c])?a.metricNames[c]:b},'')}},{key:'encodeTagsIntoMetricName',value:function encodeTagsIntoMetricName(a,b){var c='';return b&&(c='|'+JSON.stringify(b)),a+c}},{key:'measureSafe',value:function measureSafe(a,b,c,d){if(_featureDetectionService2.default.measure&&_featureDetectionService2.default.timing){b in window.performance.timing||(b=this.timelinePrefix+b),c in window.performance.timing||(c=this.timelinePrefix+c);try{this.$window.performance.measure(this.timelinePrefix+this.encodeTagsIntoMetricName(a,d),b,c)}catch(a){console.error(a)}}}},{key:'timingEvent',value:function timingEvent(a,b){if(_featureDetectionService2.default.measure&&_featureDetectionService2.default.mark&&(this.$window.performance.mark(this.timelinePrefix+a),!!this.timingRanges[a])){var c=!0,d=!1,e=void 0;try{for(var f,g=this.timingRanges[a][Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=h.from,j=h.metric,k=h.once;if(!k||!this.oneTimeMetrics[j]){if(k&&(this.oneTimeMetrics[j]=!0),'stateChange.start'===a&&'domContentLoadedEventStart'===i)return void this.timing('timeToFirstRoute',this.$window.performance.now()-this.$window.performance.timing.domContentLoadedEventStart);this.measureSafe(j,i,a,b)}}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}}}},{key:'increment',value:function increment(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.queueMetric(this.eventTypes.increment,a,1,b,c)}},{key:'histogram',value:function histogram(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=3<arguments.length&&void 0!==arguments[3]&&arguments[3];this.queueMetric(this.eventTypes.histogram,a,b,c,d)}},{key:'timing',value:function timing(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=3<arguments.length&&void 0!==arguments[3]&&arguments[3];this.queueMetric(this.eventTypes.timing,a,b,c,d)}},{key:'performanceTiming',value:function performanceTiming(a){if(this.whiteList.test(a.name)&&!this.blackList.test(a.name))if('resource'===a.entryType)'xmlhttprequest'===a.initiatorType&&this.licenceUrls.includes(a.name)?this.trackLicenseReq(a):this.timing('resourceTiming',a.duration,{url:a.name,initiatorType:a.initiatorType,cached:0!==a.decodedBodySize&&0===a.transferSize});else if('measure'===a.entryType){var b=a.name.split('|',2),c=_slicedToArray(b,2),d=c[0],e=c[1];d=d.split(this.timelinePrefix,2).pop(),e&&(e=JSON.parse(e)),this.timing(d,a.duration,e)}}},{key:'queueMetric',value:function queueMetric(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'type is undefined',b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'key is undefined',c=arguments[2],d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},e=4<arguments.length&&void 0!==arguments[4]&&arguments[4];return!this.config.enabled||this.$window.navigator.doNotTrack?!1:0===c||c?a===this.eventTypes.timing&&(!this.$window.isFinite(c)||1.2e5<c||0>c)?void this.increment('timingOutlier'):void(this.queue.push({type:a,key:b,val:c,tags:d}),e?this.flushMetrics():!this.activeBuffer&&(this.activeBuffer=this.$window.setTimeout(this.flushMetrics.bind(this),this.config.bufTime||5e3))):void 0}},{key:'encodeTags',value:function encodeTags(a){var b=[];for(var c in a)b.push(c+':'+this.normalizeTag(a[c]));return b}},{key:'buildDict',value:function buildDict(a,b){return b[a]||(b[a]=b.id++),b[a]}},{key:'encodeMetric',value:function encodeMetric(a,b){var c=this;(0===a.type||3===a.type||5===a.type)&&(a.val|=0),a.tags=this.encodeTags(a.tags),a.key=this.encodeStat(a.key),a.key=this.buildDict(a.key,b),a.tags=a.tags.map(function(a){return c.buildDict(a,b)}),'string'==typeof a.val&&(a.val=this.buildDict(a.val,b))}},{key:'preparePayload',value:function preparePayload(a){var b={codeSha:this.codeRevision,globalTag:this.globalTags.slice(),aMetric:[]},c={};Object.defineProperty(c,'id',{value:0,writable:!0,configurable:!1,enumerable:!1});var d={0:'metricValueTiming',1:'metricValueSet',2:'metricValueGuage',3:'metricValueIncrement',4:'metricValueHistogram',5:'metricValueIncrement',6:'metricValueEvent'},e=!0,f=!1,g=void 0;try{for(var h,i,j=a[Symbol.iterator]();!(e=(h=j.next()).done);e=!0)i=h.value,this.encodeMetric(i,c),b.aMetric.push(_defineProperty({tag:i.tags,type:i.type,metricName:i.key},d[i.type],i.val))}catch(a){f=!0,g=a}finally{try{!e&&j.return&&j.return()}finally{if(f)throw g}}b.stringDict=invertObjectKV(c),console.log(b.stringDict),console.log(b);var k=metricsMessage.verify(b);return k?void console.error(k):metricsMessage.encode(metricsMessage.create(b)).finish()}},{key:'flushMetrics',value:function flushMetrics(){var a=new this.XMLHttpRequest;a.open('PUT','http://localhost:3003/api/metrics'),a.setRequestHeader('Content-Type','application/octet-stream');var b=this.preparePayload(this.queue);b&&a.send(b),this.resetQueue()}}]),a}();exports.default=fsMetrics;
//# sourceMappingURL=service.js.map